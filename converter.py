"""
====================================================================
–£–ú–ù–´–ô –ö–û–ù–í–ï–†–¢–ï–† –î–û–ö–£–ú–ï–ù–¢–û–í
====================================================================
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ input/
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ output/
–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

–ê–≤—Ç–æ—Ä: –£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç Docling
–í–µ—Ä—Å–∏—è: 1.0
====================================================================
"""

import os
import json
import time
from pathlib import Path
from datetime import datetime
from docling.document_converter import DocumentConverter


# ====================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ====================================================================

# –ü–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
INPUT_DIR = Path("input")           # –ü–∞–ø–∫–∞ —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
OUTPUT_DIR = Path("output")         # –ü–∞–ø–∫–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
LOG_FILE = Path(".processing_log.json")  # –ë–∞–∑–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
SUPPORTED_FORMATS = ['.pdf', '.docx', '.pptx', '.doc', '.xlsx', '.html']


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ====================================================================

def load_processing_log():
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –∏–∑ JSON
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        dict: –°–ª–æ–≤–∞—Ä—å {–∏–º—è_—Ñ–∞–π–ª–∞: {"modified": –≤—Ä–µ–º—è, "output": –ø—É—Ç—å}}
    """
    if LOG_FILE.exists():
        with open(LOG_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
# ====================================================================

def save_processing_log(log_data):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –≤ JSON
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        log_data (dict): –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    """
    with open(LOG_FILE, 'w', encoding='utf-8') as f:
        json.dump(log_data, f, indent=2, ensure_ascii=False)


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞
# ====================================================================

def get_file_modified_time(file_path):
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        file_path (Path): –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        float: Timestamp –≤—Ä–µ–º–µ–Ω–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
    """
    return os.path.getmtime(file_path)


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–æ –ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∞–π–ª
# ====================================================================

def should_process_file(file_path, log_data):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∞–π–ª
    (–Ω–æ–≤—ã–π –∏–ª–∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏)
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        file_path (Path): –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É
        log_data (dict): –ë–∞–∑–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        bool: True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å, False –µ—Å–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
    """
    file_name = file_path.name
    current_modified = get_file_modified_time(file_path)
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ - –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
    if file_name not in log_data:
        return True
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ - –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
    last_modified = log_data[file_name].get('modified', 0)
    if current_modified > last_modified:
        return True
    
    # –§–∞–π–ª —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
    return False


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
# ====================================================================

def convert_file(file_path, converter):
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω —Ñ–∞–π–ª –≤ Markdown
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        file_path (Path): –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É
        converter: –û–±—ä–µ–∫—Ç DocumentConverter
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        tuple: (—É—Å–ø–µ—Ö, –ø—É—Ç—å_–∫_—Ä–µ–∑—É–ª—å—Ç–∞—Ç—É, –≤—Ä–µ–º—è_–æ–±—Ä–∞–±–æ—Ç–∫–∏)
    """
    start_time = time.time()
    
    try:
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        result = converter.convert(str(file_path))
        doc = result.document
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        output_filename = file_path.stem + ".md"
        output_path = OUTPUT_DIR / output_filename
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        with open(output_path, "w", encoding="utf-8") as f:
            f.write(doc.export_to_markdown())
        
        elapsed_time = time.time() - start_time
        
        return True, output_path, elapsed_time
        
    except Exception as e:
        elapsed_time = time.time() - start_time
        print(f"   ‚ùå –û—à–∏–±–∫–∞: {e}")
        return False, None, elapsed_time


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
# ====================================================================

def get_files_to_process():
    """
    –°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–∞–ø–∫—É input/ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        list: –°–ø–∏—Å–æ–∫ Path –æ–±—ä–µ–∫—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤
    """
    files_to_process = []
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ input
    if not INPUT_DIR.exists():
        print(f"‚ùå –ü–∞–ø–∫–∞ {INPUT_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return files_to_process
    
    # –°–∫–∞–Ω–∏—Ä—É–µ–º –ø–∞–ø–∫—É
    for file_path in INPUT_DIR.iterdir():
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–∞–ø–∫–∏
        if not file_path.is_file():
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
        if file_path.suffix.lower() in SUPPORTED_FORMATS:
            files_to_process.append(file_path)
    
    return files_to_process


# ====================================================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ====================================================================

def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Å–∫–∞–Ω–∏—Ä—É–µ—Ç input/, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    """
    print()
    print("=" * 70)
    print("üöÄ –£–ú–ù–´–ô –ö–û–ù–í–ï–†–¢–ï–† –î–û–ö–£–ú–ï–ù–¢–û–í")
    print("=" * 70)
    print(f"üìÇ –í—Ö–æ–¥–Ω–∞—è –ø–∞–ø–∫–∞: {INPUT_DIR.absolute()}")
    print(f"üìÇ –í—ã—Ö–æ–¥–Ω–∞—è –ø–∞–ø–∫–∞: {OUTPUT_DIR.absolute()}")
    print()
    
    # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    INPUT_DIR.mkdir(exist_ok=True)
    OUTPUT_DIR.mkdir(exist_ok=True)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    log_data = load_processing_log()
    print(f"üìã –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –±–∞–∑–∞: {len(log_data)} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ input/
    all_files = get_files_to_process()
    print(f"üìÑ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –≤ input/: {len(all_files)}")
    print()
    
    if not all_files:
        print("‚ö†Ô∏è  –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏!")
        print(f"   –ü–æ–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª—ã ({', '.join(SUPPORTED_FORMATS)}) –≤ –ø–∞–ø–∫—É {INPUT_DIR}")
        return
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ
    files_to_process = [f for f in all_files if should_process_file(f, log_data)]
    
    if not files_to_process:
        print("‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")
        print("   –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ .processing_log.json")
        return
    
    print(f"üîÑ –ù—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å: {len(files_to_process)} —Ñ–∞–π–ª–æ–≤")
    print()
    
    # –°–æ–∑–¥–∞—ë–º –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
    print("üì¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞...")
    converter = DocumentConverter()
    print("   ‚úÖ –ì–æ—Ç–æ–≤–æ!")
    print()
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
    success_count = 0
    error_count = 0
    total_time = 0
    
    for i, file_path in enumerate(files_to_process, 1):
        print(f"[{i}/{len(files_to_process)}] üìÑ {file_path.name}")
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
        success, output_path, elapsed_time = convert_file(file_path, converter)
        total_time += elapsed_time
        
        if success:
            success_count += 1
            print(f"   ‚úÖ –ì–æ—Ç–æ–≤–æ –∑–∞ {elapsed_time:.2f} —Å–µ–∫ ‚Üí {output_path.name}")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É
            log_data[file_path.name] = {
                'modified': get_file_modified_time(file_path),
                'output': str(output_path),
                'processed_at': datetime.now().isoformat(),
                'success': True
            }
        else:
            error_count += 1
        
        print()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –±–∞–∑—É
    save_processing_log(log_data)
    
    # –ò—Ç–æ–≥–∏
    print("=" * 70)
    print("üìä –ò–¢–û–ì–ò")
    print("=" * 70)
    print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ: {success_count}")
    print(f"‚ùå –û—à–∏–±–æ–∫: {error_count}")
    print(f"‚è±Ô∏è  –û–±—â–µ–µ –≤—Ä–µ–º—è: {total_time:.2f} —Å–µ–∫—É–Ω–¥")
    print(f"üìÇ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {OUTPUT_DIR.absolute()}")
    print("=" * 70)
    print()


# ====================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# ====================================================================

if __name__ == "__main__":
    main()

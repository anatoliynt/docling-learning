"""
====================================================================
–≠–ö–°–ü–û–†–¢ –î–û–ö–£–ú–ï–ù–¢–û–í –í –†–ê–ó–ù–´–ï –§–û–†–ú–ê–¢–´
====================================================================
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —ç–∫—Å–ø–æ—Ä—Ç–∞ Docling

–ê–≤—Ç–æ—Ä: –£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç Docling
–≠—Ç–∞–ø: 3.1
====================================================================
"""

import json
from pathlib import Path
from docling.document_converter import DocumentConverter


# ====================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ====================================================================

INPUT_DIR = Path("input")
OUTPUT_DIR = Path("output")


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –≤ Markdown
# ====================================================================

def export_to_markdown(doc, output_path):
    """
    –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ Markdown —Ñ–æ—Ä–º–∞—Ç
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        doc: –û–±—ä–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ Docling
        output_path (Path): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ Markdown
    markdown_content = doc.export_to_markdown()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    md_file = output_path.with_suffix('.md')
    with open(md_file, 'w', encoding='utf-8') as f:
        f.write(markdown_content)
    
    print(f"   ‚úÖ Markdown: {md_file.name} ({len(markdown_content)} —Å–∏–º–≤–æ–ª–æ–≤)")
    return str(md_file)


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
# ====================================================================

def export_to_json(doc, output_path):
    """
    –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ JSON —Å–æ –≤—Å–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        doc: –û–±—ä–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ Docling
        output_path (Path): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä—å Python
    doc_dict = doc.export_to_dict()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ JSON —Ñ–∞–π–ª
    json_file = output_path.with_suffix('.json')
    with open(json_file, 'w', encoding='utf-8') as f:
        json.dump(doc_dict, f, indent=2, ensure_ascii=False)
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    num_pages = len(doc.pages)
    num_tables = len([item for item in doc_dict.get('main_text', []) 
                      if item.get('type') == 'table'])
    
    print(f"   ‚úÖ JSON: {json_file.name}")
    print(f"      üìä –°—Ç—Ä–∞–Ω–∏—Ü: {num_pages}")
    print(f"      üìã –¢–∞–±–ª–∏—Ü: {num_tables}")
    
    return str(json_file)


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –≤ HTML
# ====================================================================

def export_to_html(doc, output_path):
    """
    –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ HTML
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        doc: –û–±—ä–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ Docling
        output_path (Path): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ HTML
    html_content = doc.export_to_html()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    html_file = output_path.with_suffix('.html')
    with open(html_file, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"   ‚úÖ HTML: {html_file.name}")
    print(f"      üåê –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞")
    
    return str(html_file)


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –≤ DocTags
# ====================================================================

def export_to_doctags(doc, output_path):
    """
    –≠–∫—Å–ø–æ—Ä—Ç –≤ DocTags —Ñ–æ—Ä–º–∞—Ç (—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Docling)
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        doc: –û–±—ä–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ Docling
        output_path (Path): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ DocTags (–û–ë–ù–û–í–õ–Å–ù–ù–´–ô –ú–ï–¢–û–î)
    doctags_content = doc.export_to_doctags()  # ‚Üê –ò–ó–ú–ï–ù–ï–ù–û!
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    doctags_file = output_path.with_suffix('.doctags.txt')
    with open(doctags_file, 'w', encoding='utf-8') as f:
        f.write(doctags_content)
    
    print(f"   ‚úÖ DocTags: {doctags_file.name}")
    print(f"      üè∑Ô∏è  –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —Ç–µ–≥–∞–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã")
    
    return str(doctags_file)    

# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü
# ====================================================================

def export_tables_only(doc, output_path):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        doc: –û–±—ä–µ–∫—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ Docling
        output_path (Path): –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str: –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    # –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –¥–æ–∫—É–º–µ–Ω—Ç–∞
    doc_dict = doc.export_to_dict()
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã
    tables = [item for item in doc_dict.get('main_text', []) 
              if item.get('type') == 'table']
    
    if not tables:
        print(f"   ‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return None
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π JSON
    tables_file = output_path.with_name(f"{output_path.stem}_tables.json")
    with open(tables_file, 'w', encoding='utf-8') as f:
        json.dump(tables, f, indent=2, ensure_ascii=False)
    
    print(f"   ‚úÖ –¢–∞–±–ª–∏—Ü—ã: {tables_file.name}")
    print(f"      üìã –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: {len(tables)}")
    
    return str(tables_file)


# ====================================================================
# –§–£–ù–ö–¶–ò–Ø: –≠–∫—Å–ø–æ—Ä—Ç –≤ –í–°–ï —Ñ–æ—Ä–º–∞—Ç—ã
# ====================================================================

def export_all_formats(file_path):
    """
    –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –≤–æ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
        file_path (Path): –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    print()
    print("=" * 70)
    print(f"üìÑ –≠–ö–°–ü–û–†–¢: {file_path.name}")
    print("=" * 70)
    print()
    
    # –°–æ–∑–¥–∞—ë–º –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä
    converter = DocumentConverter()
    
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    print("üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...")
    result = converter.convert(str(file_path))
    doc = result.document
    print("   ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω!")
    print()
    
    # –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    output_base = OUTPUT_DIR / file_path.stem
    
    # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
    print("üì¶ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–æ—Ä–º–∞—Ç—ã:")
    print()
    
    export_to_markdown(doc, output_base)
    export_to_json(doc, output_base)
    export_to_html(doc, output_base)
    export_to_doctags(doc, output_base)
    export_tables_only(doc, output_base)
    
    print()
    print("=" * 70)
    print("‚úÖ –≠–ö–°–ü–û–†–¢ –ó–ê–í–ï–†–®–Å–ù")
    print("=" * 70)
    print()


# ====================================================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ====================================================================

def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ input/
    """
    print()
    print("=" * 70)
    print("üé® –≠–ö–°–ü–û–†–¢ –î–û–ö–£–ú–ï–ù–¢–û–í –í –†–ê–ó–ù–´–ï –§–û–†–ú–ê–¢–´")
    print("=" * 70)
    print()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–æ–∫
    if not INPUT_DIR.exists():
        print(f"‚ùå –ü–∞–ø–∫–∞ {INPUT_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return
    
    OUTPUT_DIR.mkdir(exist_ok=True)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    files = list(INPUT_DIR.glob('*.*'))
    files = [f for f in files if f.suffix.lower() in ['.pdf', '.docx', '.pptx']]
    
    if not files:
        print("‚ö†Ô∏è  –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ input/")
        return
    
    print(f"üìÇ –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(files)}")
    print()
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
    for file_path in files:
        export_all_formats(file_path)
    
    print("üéâ –í—Å–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")
    print(f"üìÇ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {OUTPUT_DIR.absolute()}")
    print()


# ====================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# ====================================================================

if __name__ == "__main__":
    main()
